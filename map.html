<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í´ë” ê²Œì„</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
    }
    h1 {
      text-align: center;
    }
    .folder {
      margin: 10px 0;
      cursor: pointer;
    }
    .folder .icon {
      margin-right: 5px;
    }
    .folder .content {
      margin-left: 20px;
      display: none;
    }
    .file {
      margin-left: 20px;
    }
    .file.damaged {
        color: red; /* ì†ìƒëœ íŒŒì¼ì˜ í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ì„¤ì • */
        font-weight: bold; /* ì„ íƒ ì‚¬í•­: ê°•ì¡° íš¨ê³¼ */
    }


    /* ê¸°ë³¸ í´ë” ìƒ‰ìƒ */
    .folder .name {
      color: black;
    }

    /* ì—´ë¦° í´ë” ìƒ‰ìƒ */
    .folder.open > .name {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>í´ë” ê²Œì„</h1>
  <div id="root"></div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
        apiKey: "AIzaSyALH2cc2T41m3C8_Bqt98yFP0NJqeTTmKU",
        authDomain: "coupong-50898.firebaseapp.com",
        databaseURL: "https://coupong-50898-default-rtdb.firebaseio.com",
        projectId: "coupong-50898",
        storageBucket: "coupong-50898.firebasestorage.app",
        messagingSenderId: "396007126503",
        appId: "1:396007126503:web:e8caa6aaafb48f54a5b942",
        measurementId: "G-R2604RJDDV"
    };


    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database(app);

    const currentRoom = localStorage.getItem('currentRoom');
    if (!currentRoom) {
      alert('ë°© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      window.location.href = 'room.html';
    }

    const userRole = localStorage.getItem('role'); // ì‚¬ìš©ì ì—­í•  (Vaccine ë˜ëŠ” Malware)

// íŒŒì¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateFileState(fileElement, folderPath, fileKey) {
  const fileRef = firebase.database().ref(`${folderPath}/files/${fileKey}`);

  fileRef.once('value').then((snapshot) => {
    const fileData = snapshot.val();

    if (!fileData) return;

    if (userRole === 'Malware' && fileData.state === 'normal') {
      // ì•…ì„±ì½”ë“œ: íŒŒì¼ì„ ì†ìƒ ìƒíƒœë¡œ ë³€ê²½
      fileRef.update({ state: 'damaged' });
      fileElement.classList.remove('normal');
      fileElement.classList.add('damaged');
      fileElement.textContent = `${fileData.name} (ì†ìƒë¨)`;
    } else if (userRole === 'Vaccine' && fileData.state === 'damaged') {
      // ë°±ì‹ : ì†ìƒëœ íŒŒì¼ì„ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬
      fileRef.update({ state: 'normal' });
      fileElement.classList.remove('damaged');
      fileElement.classList.add('normal');
      fileElement.textContent = fileData.name;
    }

    console.log(`í´ë¦­ëœ íŒŒì¼ ì´ë¦„: ${fileData.name}`);
  }).catch((error) => {
    console.error(`íŒŒì¼ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ${error}`);
  });
}

// íŒŒì¼ ë Œë”ë§
function renderFiles(folderPath, files, parent) {
  Object.entries(files).forEach(([fileKey, fileData]) => {
    const fileName = fileData?.name || `íŒŒì¼ í‚¤: ${fileKey}`;
    const fileState = fileData?.state || 'normal';

    const fileElement = document.createElement('div');
    fileElement.classList.add('file', fileState);
    fileElement.textContent = fileState === 'damaged' ? `${fileName} (ì†ìƒë¨)` : fileName;

    // íŒŒì¼ í´ë¦­ ì´ë²¤íŠ¸
    fileElement.addEventListener('click', () => {
      updateFileState(fileElement, folderPath, fileKey);
    });
    parent.appendChild(fileElement);
  });
}

// í´ë” ë Œë”ë§
function renderFolders(parent, folders, folderPath = `rooms/${currentRoom}/folders`, isFirstFolder = true) {
  if (!folders || typeof folders !== 'object') {
    const noDataMessage = document.createElement('p');
    noDataMessage.textContent = 'í´ë” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
    parent.appendChild(noDataMessage);
    return;
  }

  Object.entries(folders).forEach(([folderKey, folderData]) => {
    // ì²« í´ë”ì—ì„œëŠ” subfoldersë¥¼ ê²½ë¡œì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ
    const currentFolderPath = isFirstFolder
      ? `${folderPath}/${folderKey}`
      : `${folderPath}/subfolders/${folderKey}`;

    const folderElement = document.createElement('div');
    folderElement.classList.add('folder');
    folderElement.innerHTML = `
      <span class="icon">ğŸ“</span>
      <span class="name">${folderData.name || 'ì´ë¦„ ì—†ìŒ'}</span>
      <div class="content"></div>
    `;
    parent.appendChild(folderElement);

    const subFolderParent = folderElement.querySelector('.content');

    // í˜„ì¬ í´ë”ì˜ íŒŒì¼ ë Œë”ë§
    if (folderData.files && typeof folderData.files === 'object') {
      renderFiles(currentFolderPath, folderData.files, subFolderParent);
    }

    // í•˜ìœ„ í´ë” ì¬ê·€ ë Œë”ë§
    if (folderData.subfolders && typeof folderData.subfolders === 'object') {
      renderFolders(subFolderParent, folderData.subfolders, currentFolderPath, false);
    }

    folderElement.querySelector('.name').addEventListener('click', (event) => {
      event.stopPropagation();
      const content = folderElement.querySelector('.content');
      const icon = folderElement.querySelector('.icon');

      if (content.style.display === 'none' || !content.style.display) {
        content.style.display = 'block';
        icon.textContent = 'ğŸ“‚';
        folderElement.classList.add('open');
      } else {
        content.style.display = 'none';
        icon.textContent = 'ğŸ“';
        folderElement.classList.remove('open');
      }
    });
  });
}

// Firebaseì—ì„œ í´ë” ë° íŒŒì¼ ë°ì´í„° ë¡œë“œ
function loadFolders() {
  const folderRef = firebase.database().ref(`rooms/${currentRoom}/folders`);

  folderRef.once('value')
    .then((snapshot) => {
      const folders = snapshot.val();

      if (!folders) {
        document.getElementById('root').innerHTML = '<p>í´ë” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      renderFolders(document.getElementById('root'), folders, `rooms/${currentRoom}/folders`, true);
    })
    .catch((error) => {
      console.error('Firebase ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
      document.getElementById('root').innerHTML = '<p>í´ë” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    });
}

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ
loadFolders();


  </script>
</body>
</html>
