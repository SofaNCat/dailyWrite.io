<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>폴더 게임</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
    }
    h1 {
      text-align: center;
    }
    .folder {
      margin: 10px 0;
      cursor: pointer;
    }
    .folder .icon {
      margin-right: 5px;
    }
    .folder .content {
      margin-left: 20px;
      display: none;
    }
    .file {
      margin-left: 20px;
    }
    .file.damaged {
        color: red; /* 손상된 파일의 텍스트 색상을 빨간색으로 설정 */
        font-weight: bold; /* 선택 사항: 강조 효과 */
    }


    /* 기본 폴더 색상 */
    .folder .name {
      color: black;
    }

    /* 열린 폴더 색상 */
    .folder.open > .name {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>폴더 게임</h1>
  <div id="root"></div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // Firebase 초기화
    const firebaseConfig = {
        apiKey: "AIzaSyALH2cc2T41m3C8_Bqt98yFP0NJqeTTmKU",
        authDomain: "coupong-50898.firebaseapp.com",
        databaseURL: "https://coupong-50898-default-rtdb.firebaseio.com",
        projectId: "coupong-50898",
        storageBucket: "coupong-50898.firebasestorage.app",
        messagingSenderId: "396007126503",
        appId: "1:396007126503:web:e8caa6aaafb48f54a5b942",
        measurementId: "G-R2604RJDDV"
    };


    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database(app);

    const currentRoom = localStorage.getItem('currentRoom');
    if (!currentRoom) {
      alert('방 정보가 없습니다.');
      window.location.href = 'room.html';
    }

    const userRole = localStorage.getItem('role'); // 사용자 역할 (Vaccine 또는 Malware)

// 파일 상태 업데이트
function updateFileState(fileElement, folderPath, fileKey) {
  const fileRef = firebase.database().ref(`${folderPath}/files/${fileKey}`);

  fileRef.once('value').then((snapshot) => {
    const fileData = snapshot.val();

    if (!fileData) return;

    if (userRole === 'Malware' && fileData.state === 'normal') {
      // 악성코드: 파일을 손상 상태로 변경
      fileRef.update({ state: 'damaged' });
      fileElement.classList.remove('normal');
      fileElement.classList.add('damaged');
      fileElement.textContent = `${fileData.name} (손상됨)`;
    } else if (userRole === 'Vaccine' && fileData.state === 'damaged') {
      // 백신: 손상된 파일을 정상 상태로 복구
      fileRef.update({ state: 'normal' });
      fileElement.classList.remove('damaged');
      fileElement.classList.add('normal');
      fileElement.textContent = fileData.name;
    }

    console.log(`클릭된 파일 이름: ${fileData.name}`);
  }).catch((error) => {
    console.error(`파일 데이터 로드 중 오류: ${error}`);
  });
}

// 파일 렌더링
function renderFiles(folderPath, files, parent) {
  Object.entries(files).forEach(([fileKey, fileData]) => {
    const fileName = fileData?.name || `파일 키: ${fileKey}`;
    const fileState = fileData?.state || 'normal';

    const fileElement = document.createElement('div');
    fileElement.classList.add('file', fileState);
    fileElement.textContent = fileState === 'damaged' ? `${fileName} (손상됨)` : fileName;

    // 파일 클릭 이벤트
    fileElement.addEventListener('click', () => {
      updateFileState(fileElement, folderPath, fileKey);
    });
    parent.appendChild(fileElement);
  });
}

// 폴더 렌더링
function renderFolders(parent, folders, folderPath = `rooms/${currentRoom}/folders`, isFirstFolder = true) {
  if (!folders || typeof folders !== 'object') {
    const noDataMessage = document.createElement('p');
    noDataMessage.textContent = '폴더 데이터가 없습니다.';
    parent.appendChild(noDataMessage);
    return;
  }

  Object.entries(folders).forEach(([folderKey, folderData]) => {
    // 첫 폴더에서는 subfolders를 경로에 추가하지 않음
    const currentFolderPath = isFirstFolder
      ? `${folderPath}/${folderKey}`
      : `${folderPath}/subfolders/${folderKey}`;

    const folderElement = document.createElement('div');
    folderElement.classList.add('folder');
    folderElement.innerHTML = `
      <span class="icon">📁</span>
      <span class="name">${folderData.name || '이름 없음'}</span>
      <div class="content"></div>
    `;
    parent.appendChild(folderElement);

    const subFolderParent = folderElement.querySelector('.content');

    // 현재 폴더의 파일 렌더링
    if (folderData.files && typeof folderData.files === 'object') {
      renderFiles(currentFolderPath, folderData.files, subFolderParent);
    }

    // 하위 폴더 재귀 렌더링
    if (folderData.subfolders && typeof folderData.subfolders === 'object') {
      renderFolders(subFolderParent, folderData.subfolders, currentFolderPath, false);
    }

    folderElement.querySelector('.name').addEventListener('click', (event) => {
      event.stopPropagation();
      const content = folderElement.querySelector('.content');
      const icon = folderElement.querySelector('.icon');

      if (content.style.display === 'none' || !content.style.display) {
        content.style.display = 'block';
        icon.textContent = '📂';
        folderElement.classList.add('open');
      } else {
        content.style.display = 'none';
        icon.textContent = '📁';
        folderElement.classList.remove('open');
      }
    });
  });
}

// Firebase에서 폴더 및 파일 데이터 로드
function loadFolders() {
  const folderRef = firebase.database().ref(`rooms/${currentRoom}/folders`);

  folderRef.once('value')
    .then((snapshot) => {
      const folders = snapshot.val();

      if (!folders) {
        document.getElementById('root').innerHTML = '<p>폴더 데이터가 없습니다.</p>';
        return;
      }

      renderFolders(document.getElementById('root'), folders, `rooms/${currentRoom}/folders`, true);
    })
    .catch((error) => {
      console.error('Firebase 데이터 로드 중 오류:', error);
      document.getElementById('root').innerHTML = '<p>폴더 데이터를 불러오는 중 오류가 발생했습니다.</p>';
    });
}

// 초기 데이터 로드
loadFolders();


  </script>
</body>
</html>
