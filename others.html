<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style_others.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <title>í•˜ë£¨ê¸€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="day" id="day"></div>
    <div class="title">ì˜¤ëŠ˜ì˜ ê¸€ê°</div>
    <div class="line"></div>
    <div class="word" id="word"></div>
    <div class="line"></div>
    <button class="writeBtn" onclick="go_write()">ê¸€ ì“°ê¸°</button>
    <div class="container" id="post-list">
        <!-- ì¹´ë“œë“¤ì´ í‘œì‹œë  ìë¦¬ -->
    </div>

    <footer>
        <button onclick="go_today()" class="nowHere">í•˜ë£¨ ê¸€</button>
        <button onclick="go_keep()">ë³´ê´€í•¨</button>
        <button onclick="go_vote()">íˆ¬í‘œí•¨</button>
        <button onclick="go_mypage()">ë‚´ ì„œë</button>
        <button onclick="go_option()">ë„êµ¬í•¨</button>
    </footer>
      
    <script>
        // Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyALH2cc2T41m3C8_Bqt98yFP0NJqeTTmKU",
            authDomain: "coupong-50898.firebaseapp.com",
            databaseURL: "https://coupong-50898-default-rtdb.firebaseio.com",
            projectId: "coupong-50898",
            storageBucket: "coupong-50898.firebasestorage.app",
            messagingSenderId: "396007126503",
            appId: "1:396007126503:web:e8caa6aaafb48f54a5b942",
            measurementId: "G-R2604RJDDV"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const today = new Date().toLocaleDateString("ko-KR", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            timeZone: "Asia/Seoul"
        }).replace(/\./g, "/").replace(/\s/g, "").replace(/\/$/, "");

        const dayDiv = document.getElementById("day");
        const wordDiv = document.getElementById("word");

        dayDiv.innerHTML = today

        firebase.database().ref(`word/${today}`).on("value", (snapshot) => {
            const word = snapshot.val();
            wordDiv.innerHTML = word;
        });

        const postListDiv = document.getElementById("post-list");

        // Firebaseì—ì„œ ê¸€ ê°€ì ¸ì˜¤ê¸°
        firebase.database().ref(`posts/${today}`).on("value", (snapshot) => {
            const posts = snapshot.val();
            postListDiv.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

            if (!posts || Object.keys(posts).length === 0) {
                postListDiv.innerHTML = `
                    <div class="no-posts" style="text-align: center; font-size: 18px; color: #999; padding: 20px;">
                        ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤!<br>ì˜¤ëŠ˜ì˜ ê¸€ê°ìœ¼ë¡œ ê¸€ì„ ì‘ì„±í•´ ë³´ì„¸ìš”.
                    </div>
                `;
                return;
            }

            const userId = localStorage.getItem('dailyWrite_user') || "guest"; // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°

            for (const postId in posts) {
                const post = posts[postId];
                const likeCount = post.like || 0;

                // ì¹´ë“œ ìš”ì†Œ ìƒì„±
                const cardDiv = document.createElement("div");
                cardDiv.className = "card";

                const rowDiv = document.createElement("div");
                rowDiv.className = "row";
                rowDiv.innerHTML = `<p>${post.age}ëŒ€</p><p>${post.time}</p>`;
                cardDiv.appendChild(rowDiv);

                const centerRowDiv = document.createElement("div");
                centerRowDiv.className = "row center";
                centerRowDiv.innerHTML = `<h3>ì œëª©: ${post.title}</h3>`;
                cardDiv.appendChild(centerRowDiv);

                const contentDiv = document.createElement("div");
                contentDiv.className = "content";

                // <br> íƒœê·¸ë¥¼ ì¤„ë°”ê¿ˆ(\n)ìœ¼ë¡œ ë³€í™˜
                const sanitizedContent = post.content.replace(/<br\s*\/?>/g, "\n");

                // í…ìŠ¤íŠ¸ë¥¼ ì¤„ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ê¸°
                const lines = sanitizedContent.split("\n");
                let limitedContent = sanitizedContent;

                // ì¡°ê±´ 1: ê¸€ì ìˆ˜ê°€ 200ìë¥¼ ì´ˆê³¼í•˜ëŠ” ê²½ìš°
                if (sanitizedContent.length > 200) {
                    limitedContent = sanitizedContent.substring(0, 200) + "...";
                }

                // ì¡°ê±´ 2: ì¤„ ìˆ˜ê°€ 6ì¤„ì„ ì´ˆê³¼í•˜ëŠ” ê²½ìš°
                if (lines.length > 6) {
                    limitedContent = lines.slice(0, 6).join("\n") + "\n...";
                }

                // ì´ˆê¸° ìƒíƒœë¡œ ì§§ì€ í…ìŠ¤íŠ¸ ì„¤ì •
                contentDiv.textContent = limitedContent;

                // í† ê¸€ ìƒíƒœ ë³€ìˆ˜ ì¶”ê°€
                let isExpanded = false;

                // í´ë¦­ ì‹œ ê¸´ ê¸€/ì§§ì€ ê¸€ í† ê¸€
                contentDiv.addEventListener("click", () => {
                    isExpanded = !isExpanded; // í† ê¸€ ìƒíƒœ ë³€ê²½
                    if (isExpanded) {
                        contentDiv.textContent = sanitizedContent; // ê¸´ ê¸€ í‘œì‹œ
                    } else if (sanitizedContent.split("\n").length > 6) {
                        // ì¤„ ìˆ˜ê°€ 6ì¤„ì„ ì´ˆê³¼í•˜ëŠ” ê²½ìš°
                        contentDiv.textContent = sanitizedContent.split("\n").slice(0, 6).join("\n") + "\n...";
                    } else {
                        // ê¸€ì ìˆ˜ 200ì ë¯¸ë§Œì´ê³  6ì¤„ ì´í•˜ì¸ ê²½ìš°
                        contentDiv.textContent = sanitizedContent;
                    }
                });
                cardDiv.appendChild(contentDiv);

                const likesDiv = document.createElement("div");
                likesDiv.className = "row likes";

                const likeBtn = document.createElement("button");
                likeBtn.style.background = "none";
                likeBtn.style.border = "none";
                likeBtn.style.cursor = "pointer";
                likeBtn.textContent = "ğŸ¤"; // ê¸°ë³¸ ìƒíƒœ
                likesDiv.appendChild(likeBtn);

                const likeCountSpan = document.createElement("span");
                likeCountSpan.textContent = likeCount;
                likesDiv.appendChild(likeCountSpan);

                cardDiv.appendChild(likesDiv);
                postListDiv.appendChild(cardDiv);

                // Firebaseì—ì„œ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ í›„ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                firebase.database().ref(`posts/${today}/${postId}/likes/${userId}`).once("value", (snapshot) => {
                    const isLiked = snapshot.val() || false;
                    likeBtn.textContent = isLiked ? "â¤ï¸" : "ğŸ¤";
                });

                // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                likeBtn.addEventListener("click", async () => {
                    const currentLiked = likeBtn.textContent === "â¤ï¸";
                    const currentLikeCount = parseInt(likeCountSpan.textContent, 10) || 0;
                    const newLikedState = !currentLiked;
                    const newLikeCount = newLikedState ? currentLikeCount + 1 : currentLikeCount - 1;

                    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    likeBtn.textContent = newLikedState ? "â¤ï¸" : "ğŸ¤";
                    likeCountSpan.textContent = newLikeCount;

                    try {
                        // ì‚¬ìš©ìë³„ ì¢‹ì•„ìš” ìƒíƒœ ì €ì¥
                        await firebase.database().ref(`posts/${today}/${postId}/likes/${userId}`).set(newLikedState);

                        // ì „ì²´ ì¢‹ì•„ìš” ìˆ˜ ê³„ì‚°
                        const likesSnapshot = await firebase.database().ref(`posts/${today}/${postId}/likes`).once("value");
                        const likes = likesSnapshot.val() || {};
                        const totalLikes = Object.values(likes).filter((liked) => liked).length;

                        // Firebaseì— ì „ì²´ ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
                        await firebase.database().ref(`posts/${today}/${postId}`).update({
                            like: totalLikes,
                        });

                        // ìµœì¢… UI ë™ê¸°í™”
                        likeCountSpan.textContent = totalLikes;
                    } catch (error) {
                        console.error("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);

                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ UI ë¡¤ë°±
                        likeBtn.textContent = currentLiked ? "â¤ï¸" : "ğŸ¤";
                        likeCountSpan.textContent = currentLikeCount;
                    }
                });
            }
        });

        function go_write() {
            const userId = localStorage.getItem('dailyWrite_user') || "guest"; // ì‚¬ìš©ì ID
            const postsPath = `posts/${today}`; // ì˜¤ëŠ˜ ë‚ ì§œ ê²½ë¡œ

            // Firebaseì—ì„œ ì‚¬ìš©ìê°€ ì˜¤ëŠ˜ ì“´ ê¸€ì´ ìˆëŠ”ì§€ í™•ì¸
            firebase.database().ref(postsPath).once("value").then((snapshot) => {
                const posts = snapshot.val();
                let hasWritten = false;

                if (posts) {
                    for (const postId in posts) {
                        if (posts[postId].user === userId) {
                            hasWritten = true;
                            break;
                        }
                    }
                }

                if (hasWritten) {
                    alert("ì˜¤ëŠ˜ ì´ë¯¸ ê¸€ì„ ì‘ì„±í•˜ì…¨ìŠµë‹ˆë‹¤!");
                } else {
                    window.location.href = `write.html`;
                }
            }).catch((error) => {
                console.error("ê¸€ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                alert("ê¸€ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë²„íŠ¼ ë¹„í™œì„±í™” í™•ì¸
        document.addEventListener("DOMContentLoaded", () => {
            const userId = localStorage.getItem('dailyWrite_user') || "guest"; // ì‚¬ìš©ì ID
            const postsPath = `posts/${today}`; // ì˜¤ëŠ˜ ë‚ ì§œ ê²½ë¡œ
            const writeButton = document.querySelector(".writeBtn");

            // Firebaseì—ì„œ ì‚¬ìš©ìê°€ ì˜¤ëŠ˜ ì“´ ê¸€ì´ ìˆëŠ”ì§€ í™•ì¸
            firebase.database().ref(postsPath).once("value").then((snapshot) => {
                const posts = snapshot.val();
                let hasWritten = false;

                if (posts) {
                    for (const postId in posts) {
                        if (posts[postId].user === userId) {
                            hasWritten = true;
                            break;
                        }
                    }
                }

                if (hasWritten) {
                    writeButton.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”
                    writeButton.style.opacity = "0.6"; // ì‹œê°ì ìœ¼ë¡œ ë¹„í™œì„±í™”
                    writeButton.style.cursor = "not-allowed"; // ë¹„í™œì„±í™” ì»¤ì„œ
                }
            }).catch((error) => {
                console.error("ê¸€ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            });
        });

        function go_today() {
            window.location.href = `others.html`;
        }
        function go_keep() {
            window.location.href = `keep.html`;
        }
    </script>

</body>
</html>
